name: Deploy Next.js App to Windows Server (Windows Runner)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  DEPLOY_PATH: "C:/deploy/sample"

jobs:
  build_and_deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ✅ Confirm directory structure
      - name: Verify current directory structure
        shell: powershell
        run: |
          Write-Host "Current directory:" (Get-Location)
          Write-Host "Top-level folders:"
          Get-ChildItem -Name
          Write-Host "Check if my-app/package.json exists:"
          Test-Path 'my-app\package.json'

      - name: Install dependencies and build
        shell: powershell
        run: |
          Write-Host "Moving into project folder..."
          cd my-app  # ✅ FIXED PATH

          if (!(Test-Path "package.json")) {
            Write-Error "package.json not found in $(Get-Location). Check your folder structure."
            exit 1
          }

          Write-Host "Installing dependencies..."
          npm ci

          Write-Host "Building Next.js app..."
          npm run build

          Write-Host "✅ Build completed successfully!"

      - name: Upload build to Windows Server
        uses: appleboy/scp-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "./my-app/*"   # ✅ FIXED PATH
          target: ${{ env.DEPLOY_PATH }}

      - name: Start or Restart App on Windows Server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script_stop: true
          script: |
            powershell -NoProfile -NonInteractive -Command "
              Write-Host 'Starting deployment on Windows Server...';
              $deploy = '${{ env.DEPLOY_PATH }}';

              if (!(Test-Path $deploy)) {
                Write-Host 'Creating deployment folder...';
                New-Item -ItemType Directory -Force -Path $deploy | Out-Null;
              }

              cd $deploy;

              Write-Host 'Installing production dependencies...';
              npm install --production;

              Write-Host 'Checking PM2 installation...';
              if (-not (Get-Command pm2 -ErrorAction SilentlyContinue)) {
                npm install -g pm2;
              }

              Write-Host 'Starting or restarting the Next.js app...';
              pm2 restart sample -s -ErrorAction SilentlyContinue;
              if ($LASTEXITCODE -ne 0) {
                pm2 start npm --name 'sample' -- start;
              }

              pm2 save;
              Write-Host '✅ Deployment complete and app is running!';
            "
