name: Deploy Next.js App to Windows Server (Windows Runner)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  DEPLOY_PATH: "C:/deploy/sample"

jobs:
  build_and_deploy:
    runs-on: windows-latest  # ğŸ‘ˆ Use Windows GitHub runner instead of Ubuntu

    steps:
      - name: ğŸ›’ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Install dependencies and build (Windows environment)
        shell: powershell
        run: |
          Write-Host "ğŸ“ Moving into Next.js project folder..."
          cd my-app
          Write-Host "ğŸ“¦ Installing dependencies..."
          npm ci
          Write-Host "ğŸ—ï¸ Building Next.js app..."
          npm run build

      - name: ğŸ“¤ Copy files to Windows Server
        uses: appleboy/scp-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "./my-app/*"
          target: ${{ env.DEPLOY_PATH }}

      - name: ğŸš€ Start app on Windows Server using PM2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script_stop: true
          script: |
            powershell -NoProfile -NonInteractive -Command "
              Write-Host '--- Deploying Next.js app to Windows Server ---';
              $deploy = '${{ env.DEPLOY_PATH }}';

              if (!(Test-Path $deploy)) {
                Write-Host 'Creating deployment folder...';
                New-Item -ItemType Directory -Force -Path $deploy | Out-Null;
              }

              cd $deploy;

              Write-Host 'Installing production dependencies...';
              npm install --production;

              Write-Host 'Ensuring PM2 is installed...';
              if (-not (Get-Command pm2 -ErrorAction SilentlyContinue)) {
                npm install -g pm2;
              }

              Write-Host 'Starting or restarting the app...';
              pm2 restart sample -s -ErrorAction SilentlyContinue;
              if ($LASTEXITCODE -ne 0) {
                pm2 start npm --name 'sample' -- start;
              }

              pm2 save;
              Write-Host 'âœ… Deployment complete!';
            "
