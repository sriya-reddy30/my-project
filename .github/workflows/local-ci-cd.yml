name: Deploy Next.js App to Windows Server

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH || 'C:/deploy/sample' }}

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üõí Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üì¶ Install dependencies and build
        run: |
          cd my-app
          npm ci
          npm run build

      - name: üì§ Copy files to Windows Server
        uses: appleboy/scp-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "sample/*"
          target: "${{ env.DEPLOY_PATH }}" 

      - name: üöÄ Run app on Windows Server using PM2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            powershell -NoProfile -NonInteractive -Command "
              Write-Host '--- Connecting to server and preparing deployment ---';
              $deploy = '${{ env.DEPLOY_PATH }}';

              if (!(Test-Path $deploy)) {
                Write-Host 'Creating deployment folder...';
                New-Item -ItemType Directory -Force -Path $deploy | Out-Null;
              }

              cd $deploy;
              Write-Host 'Installing production dependencies...';
              npm install --production;

              Write-Host 'Building Next.js app...';
              npm run build;

              Write-Host 'Starting app with PM2...';
              pm2 restart sample -s || pm2 start npm --name 'sample' -- start;

              Write-Host 'Saving PM2 process list...';
              pm2 save;

              Write-Host '‚úÖ Deployment complete!';
            "
