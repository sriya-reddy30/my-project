name: Deploy Next.js App to Windows Server (Windows Runner)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  DEPLOY_PATH: "C:/deploy/sample"

jobs:
  build_and_deploy:
    runs-on: windows-latest  # ğŸ‘ˆ Run the entire CI/CD pipeline in Windows

    steps:
      - name: ğŸ›’ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ§¾ Debug folder structure
        shell: powershell
        run: |
          Write-Host "ğŸ“ Current directory: $(Get-Location)"
          Write-Host "ğŸ“‚ Files at root:"
          Get-ChildItem -Name

      - name: ğŸ“¦ Install dependencies and build (Windows)
        shell: powershell
        run: |
          Write-Host "ğŸ“ Moving into Next.js project folder..."
          cd my-app
          Write-Host "ğŸ“¦ Installing dependencies..."
          npm ci
          Write-Host "ğŸ§¾ Checking available npm scripts..."
          npm run
          Write-Host "ğŸ—ï¸ Building Next.js app..."
          npm run build
          Write-Host "âœ… Build completed successfully!"

      - name: ğŸ“¤ Upload build to Windows Server
        uses: appleboy/scp-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "./my-app/*"
          target: ${{ env.DEPLOY_PATH }}

      - name: ğŸš€ Start or Restart App on Windows Server
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script_stop: true
          script: |
            powershell -NoProfile -NonInteractive -Command "
              Write-Host '--- ğŸš€ Starting Deployment on Windows Server ---';
              $deploy = '${{ env.DEPLOY_PATH }}';

              if (!(Test-Path $deploy)) {
                Write-Host 'ğŸ“‚ Creating deployment folder...';
                New-Item -ItemType Directory -Force -Path $deploy | Out-Null;
              }

              Write-Host 'ğŸ“ Changing directory to deployment path...';
              cd $deploy;

              Write-Host 'ğŸ“¦ Installing production dependencies...';
              npm install --production;

              Write-Host 'âš™ï¸ Checking PM2 installation...';
              if (-not (Get-Command pm2 -ErrorAction SilentlyContinue)) {
                Write-Host 'Installing PM2 globally...';
                npm install -g pm2;
              }

              Write-Host 'ğŸš€ Starting or restarting the Next.js app...';
              pm2 restart sample -s -ErrorAction SilentlyContinue;
              if ($LASTEXITCODE -ne 0) {
                pm2 start npm --name 'sample' -- start;
              }

              pm2 save;
              Write-Host 'âœ… Deployment complete and app is running!';
            "
