name: Deploy Next.js App to Windows Server (Native PowerShell)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  DEPLOY_PATH: "C:\\deploy\\sample"

jobs:
  build_and_deploy:
    runs-on: windows-latest  # ✅ Native Windows runner

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build Next.js app
        shell: powershell
        run: |
          Write-Host "Building project..."
          cd my-app
          npm ci
          npm run build
          Write-Host "✅ Build completed."

      - name: Deploy build to Windows Server (PowerShell)
        shell: powershell
        run: |
          $server = "${{ secrets.SERVER_IP }}"
          $username = "${{ secrets.SERVER_USER }}"
          $password = "${{ secrets.SERVER_PASSWORD }}" | ConvertTo-SecureString -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential($username, $password)
          $session = New-PSSession -ComputerName $server -Credential $cred -Authentication Basic

          $deployPath = "${{ env.DEPLOY_PATH }}"

          Write-Host "Creating deploy folder if missing..."
          Invoke-Command -Session $session -ScriptBlock {
            param($deployPath)
            if (!(Test-Path $deployPath)) {
              New-Item -ItemType Directory -Path $deployPath | Out-Null
            }
          } -ArgumentList $deployPath

          Write-Host "Copying files..."
          Copy-Item -Path "my-app\\*" -Destination "\\$server\C$\deploy\sample" -Recurse -Force

          Write-Host "Installing dependencies & restarting app remotely..."
          Invoke-Command -Session $session -ScriptBlock {
            param($deployPath)
            cd $deployPath
            if (!(Get-Command pm2 -ErrorAction SilentlyContinue)) {
              npm install -g pm2
            }
            npm install --production
            pm2 restart sample -s -ErrorAction SilentlyContinue
            if ($LASTEXITCODE -ne 0) {
              pm2 start npm --name 'sample' -- start
            }
            pm2 save
          } -ArgumentList $deployPath

          Write-Host "✅ Deployment complete!"
          Remove-PSSession $session
